<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Map View</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <!-- using the stlyes.css too -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/map.css') }}">

  <style>
    #map { height: 90vh; width: 100%; }
    body { margin: 0; font-family: sans-serif; }
    h2 { text-align: center; margin: 1em 0; }
  </style>
</head>
<body>
  <div class="wrapper">
    <header class="dashboard-header">
      <h1>SNMPy Network Monitoring - Map of Sites</h1>
      <nav class="main-nav">
        <a href="/" class="nav-link">🏠 Home</a>
        <a href="/snmp" class="nav-link">📡 SNMP Monitor</a>
        <a href="/map" class="nav-link">🗺 Map</a>
        <a href="/charts" class="nav-link">📊 Charts</a>
        <a href="/admin" class="nav-link">⚙️ Admin</a>
        <a href="/logs" class="nav-link">🪵 Logs</a>
      </nav>
    </header>
  </div>

  <div id="map"></div>

  <!-- Load SNMP data into JS -->
  <script>
    const snmps = {{ snmps | tojson }};
  </script>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
  const map = L.map('map').setView([34.5, 9.3], 6);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  const markers = {};

  function formatSNMPTable(snmpEntries) {
    if (!snmpEntries || snmpEntries.length === 0) return "<i>No SNMP data</i>";
    let table = '<table style="width:100%; font-size: 0.9rem;">';
    for (const entry of snmpEntries) {
      table += `<tr><td><b>${entry.label}</b></td><td>${entry.value}</td></tr>`;
    }
    table += '</table>';
    return table;
  }

  async function loadMarkers() {
    try {
      const response = await fetch("/api/sites_status");
      const data = await response.json();

      for (const id in data) {
        const site = data[id];
        if (!site.lat || !site.lon) continue;

        const color = site.status?.toLowerCase() === "up" ? "green" : "red";

        const marker = L.circleMarker([site.lat, site.lon], {
          radius: 8,
          color,
          fillColor: color,
          fillOpacity: 0.9
        }).addTo(map);

        const snmpTable = formatSNMPTable(snmps[id]);
        const latency = site.latency !== null ? `${site.latency} ms` : 'N/A';

        marker.bindPopup(`
          <b>${site.name}</b><br>
          Status: <span style="color:${color}; font-weight:bold">${site.status}</span><br>
          Latency: ${latency}<br>
          ${snmpTable}
        `);

        markers[id] = marker;
      }
    } catch (err) {
      console.error("Failed to load markers:", err);
    }
  }

  async function updateSiteStatuses() {
    try {
      const res = await fetch("/api/sites_status");
      const data = await res.json();

      for (const id in data) {
        const site = data[id];
        const color = site.status?.toLowerCase() === "up" ? "green" : "red";

        if (!markers[id]) continue;

        markers[id].setStyle({ color, fillColor: color });

        const snmpTable = formatSNMPTable(snmps[id]);
        const latency = site.latency !== null ? `${site.latency} ms` : 'N/A';

        markers[id].setPopupContent(`
          <b>${site.name}</b><br>
          Status: <span style="color:${color}; font-weight:bold">${site.status}</span><br>
          Latency: ${latency}<br>
          ${snmpTable}
        `);
      }
    } catch (err) {
      console.error("Error updating statuses:", err);
    }
  }

  loadMarkers();
  setInterval(updateSiteStatuses, 15000);
</script>

</body>

</html>
